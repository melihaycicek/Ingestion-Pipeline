# ==============================================================================
# OctoSky — Nginx Configuration
# Deploy to: /etc/nginx/sites-available/octosky
# Symlink  : ln -s /etc/nginx/sites-available/octosky /etc/nginx/sites-enabled/
# Reload   : sudo nginx -t && sudo systemctl reload nginx
# ==============================================================================

server {
    listen 80;
    listen [::]:80;

    # Replace with your actual domain or IP.
    server_name _;

    root /var/www/html;

    # ------------------------------------------------------------------
    # Static JSON API — weather.json
    # ------------------------------------------------------------------
    location = /weather.json {
        # ---- CORS Headers (allow any external domain to fetch) --------
        add_header 'Access-Control-Allow-Origin'  '*'           always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
        add_header 'Access-Control-Max-Age'       '86400'       always;

        # Handle preflight OPTIONS requests.
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin'  '*';
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With';
            add_header 'Access-Control-Max-Age'       '86400';
            add_header 'Content-Type'                 'text/plain; charset=utf-8';
            add_header 'Content-Length'                '0';
            return 204;
        }

        # ---- Caching -------------------------------------------------
        # Short cache so widgets pick up fresh scrapes quickly.
        add_header 'Cache-Control' 'public, max-age=120, s-maxage=60' always;

        # Force JSON content type (even if mime.types doesn't map .json).
        default_type application/json;

        # Serve the static file directly.
        try_files $uri =404;
    }

    # ------------------------------------------------------------------
    # Default location — serve other static files or a landing page.
    # ------------------------------------------------------------------
    location / {
        try_files $uri $uri/ =404;
    }

    # ------------------------------------------------------------------
    # Security hardening headers
    # ------------------------------------------------------------------
    add_header X-Content-Type-Options  "nosniff"        always;
    add_header X-Frame-Options         "SAMEORIGIN"     always;
    add_header Referrer-Policy         "strict-origin-when-cross-origin" always;

    # ------------------------------------------------------------------
    # Logging
    # ------------------------------------------------------------------
    access_log /var/log/nginx/octosky_access.log;
    error_log  /var/log/nginx/octosky_error.log;
}
